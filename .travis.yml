language: c

dist: trusty

env: GHCVER=8.0.2 SCRIPT=release
sudo: required
os: linux

# Note: the distinction between `before_install` and `install` is not important.
before_install:
 - export PATH=/opt/ghc/$GHCVER/bin:$PATH
 - export PATH=$HOME/.ghc-install/$GHCVER/bin:$PATH
 - export PATH=$HOME/bin:$PATH
 - export PATH=$HOME/.cabal/bin:$PATH
 - export PATH=$HOME/.local/bin:$PATH
 - export PATH=/opt/cabal/1.24/bin:$PATH
 - export PATH=/opt/happy/1.19.5/bin:$PATH
 - export PATH=/opt/alex/3.1.7/bin:$PATH
 - ./travis-install.sh

install:
 # We intentionally do not install anything before trying to build Cabal because
 # it should build with each supported GHC version out-of-the-box.

# Here starts the actual work to be performed for the package under test; any
# command which exits with a non-zero exit code causes the build to fail. Using
# ./dist/setup/setup here instead of cabal-install to avoid breakage when the
# build config format changed.
script:
 - rm -rf dist-newstyle
 - ./travis-${SCRIPT}.sh -j2

cache:
 directories:
 - $HOME/.cabal/packages
 - $HOME/.cabal/store
 - $HOME/.cabal/bin

 - $HOME/.stack/bin
 - $HOME/.stack/precompiled
 - $HOME/.stack/programs
 - $HOME/.stack/setup-exe-cache
 - $HOME/.stack/snapshots

# We remove the index because it churns quite a bit and we don't want
# to pay the cost of repeatedly caching it even though we don't care
# about most changing packages.
before_cache:
 - rm -fv $HOME/.cabal/packages/hackage.haskell.org/build-reports.log
 - rm -fv $HOME/.cabal/packages/hackage.haskell.org/00-index*
 - rm -fv $HOME/.cabal/packages/hackage.haskell.org/01-index*
 - rm -fv $HOME/.cabal/packages/hackage.haskell.org/*.json

deploy:
  on:
    branch: 2.0-staging
  provider: s3
  # Below 3 values are configured as environmental variables in Travis web console
  access_key_id: $ARTIFACTS_KEY
  secret_access_key: $ARTIFACTS_SECRET
  bucket: $ARTIFACTS_BUCKET
  # Prevent Travis from deleting build directory
  skip_cleanup: true
  acl: public_read
  # Path to build artifacts
  local_dir: $HOME/cabal-install-SNAPSHOT
  upload_dir: travis_builds
  # Set the Cache-Control header.
  cache_control: "max-age=21600"

notifications:
  irc:
    channels:
      - "chat.freenode.net##haskell-cabal"
  slack: haskell-cabal:sCq6GLfy9N8MJrInosg871n4
